name: ISO Release

permissions:
  contents: write
  actions: read

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Optional release tag to use when creating a release (creates tag on branch head)'
        required: false
        default: ''
      release_name:
        description: 'Optional release name'
        required: false
        default: ''
      release_branch:
        description: 'Branch to tag when release_tag is provided (default: main)'
        required: false
        default: 'main'

jobs:
  iso-release:
    name: Build, sign, and release ISO
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install required tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            ca-certificates curl gnupg2 jq make xorriso tar unzip python3 yq
          # install gh CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod 644 /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y gh
          # clean apt cache
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
          gh --version
          yq --version

      - name: Create ISO artifacts via Makefile
        id: make_iso
        run: |
          set -euo pipefail
          ts=$(date -u +%Y%m%d%H%M%S)
          echo "Timestamp: ${ts}"
          make iso TS="${ts}"
          # collect all ISOs built for this timestamp
          isos=$(ls -1 docker-refplat-images-*"${ts}".iso 2>/dev/null || true)
          [ -n "${isos}" ] || { echo "No ISO files found for TS=${ts}"; exit 1; }
          echo "Found ISO files:" && printf "%s\n" ${isos}
          echo "ts=${ts}" >> "$GITHUB_OUTPUT"
          isos_json=$(jq -nc '$ARGS.positional' --args ${isos})
          echo "isos_json=${isos_json}" >> "$GITHUB_OUTPUT"

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Create detached ASCII signatures for ISOs
        env:
          GPG_FPR: ${{ steps.import_gpg.outputs.fingerprint }}
          PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          export GNUPGHOME="${GNUPGHOME:-$HOME/.gnupg}"
          echo "allow-loopback-pinentry" > "$GNUPGHOME/gpg-agent.conf"
          gpgconf --reload gpg-agent
          # sign every ISO from previous step
          for iso in $(jq -r '.[]' <<< '${{ steps.make_iso.outputs.isos_json }}'); do
            [ -n "$iso" ] || continue
            [ -f "$iso" ] || { echo "Missing ISO file: $iso"; exit 1; }
            echo "Signing $iso -> ${iso}.asc"
            gpg --batch --yes --pinentry-mode loopback \
                --passphrase "${PASSPHRASE}" \
                --local-user "${GPG_FPR}" \
                --armor --output "${iso}.asc" --detach-sign "$iso"
          done

      - name: Determine/prepare release tag
        id: tagprep
        run: |
          set -euo pipefail
          # prefer pushed tag; else use input; else iso-<ts>
          if [ -n "${GITHUB_REF:-}" ] && [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            tag="${GITHUB_REF#refs/tags/}"
            echo "Using pushed tag: ${tag}"
          elif [ -n "${{ inputs.release_tag }}" ]; then
            tag="${{ inputs.release_tag }}"
            branch="${{ inputs.release_branch }}"; [ -n "$branch" ] || branch="main"
            # resolve branch head commit and create tag if missing
            sha=$(gh api "repos/${GITHUB_REPOSITORY}/git/refs/heads/${branch}" --jq '.object.sha')
            if gh api "repos/${GITHUB_REPOSITORY}/git/refs/tags/${tag}" >/dev/null 2>&1; then
              echo "Tag '${tag}' already exists"
            else
              echo "Creating tag refs/tags/${tag} -> ${sha}"
              gh api "repos/${GITHUB_REPOSITORY}/git/refs" -f ref="refs/tags/${tag}" -f sha="${sha}" >/dev/null
            fi
          else
            ts=$(date -u +%Y%m%d%H%M%S)
            tag="iso-${ts}"
            echo "No tag provided; using ${tag}"
          fi
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release (draft) and upload ISOs
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag != '') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag='${{ steps.tagprep.outputs.tag }}'
          name='${{ inputs.release_name }}'; [ -n "$name" ] || name="Automated ISO release ${tag}"
          # Generate inventory on demand and use as release notes
          images_root="BUILD/debian/refplat-images-docker/var/lib/libvirt/images"
          ./scripts/generate-iso-inventory.sh '${{ steps.make_iso.outputs.ts }}' "$images_root" > ISO_INVENTORY.md
          notes_file="ISO_INVENTORY.md"
          # create release idempotently as draft (not latest)
          if gh release view "${tag}" >/dev/null 2>&1; then
            echo "Release '${tag}' already exists"
            gh release edit "${tag}" --notes-file "$notes_file"
          else
            gh release create "${tag}" --title "${name}" --notes-file "$notes_file" --draft
          fi
          # upload all ISOs + signatures
          jq -r '.[]' <<< '${{ steps.make_iso.outputs.isos_json }}' | while IFS= read -r iso; do
            [ -n "$iso" ] || continue
            [ -f "$iso" ] || { echo "Missing ISO file: $iso"; exit 1; }
            [ -f "${iso}.asc" ] || { echo "Missing signature: ${iso}.asc"; exit 1; }
            gh release upload "${tag}" "$iso" "${iso}.asc" --clobber
          done
          # also upload the inventory markdown as an asset
          # gh release upload "${tag}" "$notes_file" --clobber

      - name: List artifacts
        run: |
          ls -la | sed -n '1,200p'
