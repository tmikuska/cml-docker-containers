name: Build

permissions:
   contents: write

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub release from built artifacts'
        required: false
        default: 'false'
      release_tag:
        description: 'Optional release tag to use when creating a release'
        required: false
        default: ''
      release_name:
        description: 'Optional release name'
        required: false
        default: ''

jobs:
  build:
    name: Build containers and package .deb
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Discover top-level containers (Dockerfile && not .disabled)
        id: discover
        run: |
          set -euo pipefail
          containers=()
          for d in ./*/; do
            [ -d "$d" ] || continue
            dir="${d#./}"
            dir="${dir%/}"
            if [ -f "${dir}/Dockerfile" ] && [ ! -f "${dir}/.disabled" ]; then
              containers+=("$dir")
            fi
          done
          printf '%s\n' "${containers[@]}" > containers.list
          echo "discovered=$(wc -l < containers.list || true)" >> "$GITHUB_OUTPUT"

      - name: Build each container sequentially
        run: |
          set -euo pipefail
          if [ ! -f containers.list ]; then
            echo "No containers found; nothing to build."
            exit 0
          fi
          while IFS= read -r c; do
            echo "=== Building: $c ==="
            make -C "$c"
          done < containers.list

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends devscripts dpkg-dev build-essential fakeroot debhelper

      - name: Bump changelog with timestamped version and exact message
        id: bump
        env:
          DEBFULLNAME: "${{ github.actor }} (GitHub Actions)"
          DEBEMAIL: "${{ github.actor }}@users.noreply.github.com"
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          # read current version from BUILD/debian/changelog
          version=$(dpkg-parsechangelog -l BUILD/debian/changelog -SVersion)
          base=${version%%-*}
          if [ -z "$base" ]; then
            echo "Cannot determine base version from BUILD/debian/changelog" >&2
            exit 1
          fi
          ts=$(date -u +%Y%m%d%H%M%S)   # UTC timestamp YYYYMMDDHHMMSS
          new="${base}+${ts}"
          datehuman=$(date -u +"%Y-%m-%d %H:%M:%SZ")
          echo "Bumping changelog to ${new}"
          cd BUILD
          export DEBFULLNAME="${DEBFULLNAME}"
          export DEBEMAIL="${DEBEMAIL}"
          # exact requested message
          dch -v "$new" "auto-built on github on ${datehuman}"
          echo "Top of BUILD/debian/changelog:"
          sed -n '1,12p' debian/changelog

          # create build metadata for downstream release job (omit ts; release can create its own timestamp)
          cd ..
          cat > build-metadata.json <<EOF
{"ts":"${ts}","version":"${new}","run_id":${{ github.run_id }},"commit":"${GITHUB_SHA}"}
EOF


      - name: Build .deb package
        run: |
          set -euo pipefail
          make deb

      - name: Pack refplat var/lib subtree as pruned tarball
        run: |
          set -euo pipefail
          src_dir="BUILD/debian/refplat-images-docker"
          ts="${{ steps.bump.outputs.ts }}"
          out_tar="docker-refplat-images-${ts}.tar.gz"
          if [ -d "${src_dir}/var/lib" ]; then
            echo "Creating ${out_tar} containing var/lib/..."
            (cd "${src_dir}" && tar -czf "../../../docker-refplat-images-${ts}.tar.gz" var/lib)
            ls -lh "${out_tar}" || true
          else
            echo "No var/lib subtree found at ${src_dir}/var/lib â€” skipping tar creation."
          fi

      - name: Upload packaging artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-artifacts-${{ github.run_id }}
          path: |
            *.deb
            *.changes
            *.buildinfo
            docker-refplat-images-*.tar.gz
            build-metadata.json
          retention-days: 10
